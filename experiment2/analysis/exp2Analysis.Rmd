---
title: "KeysarMouseTracking.csv"
output: html_document
---

```{r}
setwd('~/Repos/keysar_replication/experiment2/data/')
preMouseDExp2 = read.csv('mouse/exp2Mouse.csv')
preErrorDExp2 = read.csv('error/exp2Error.csv')
preMessageDExp2 = read.csv('message/exp2Message.csv')
library(tidyr)
library(dplyr)
library(ggplot2)
library(lme4)
library(lmerTest)
```

Set up error data

```{r}
nonNativeEnglishIDs <- c("0366-3", "8676-f")
nonCriticalMistakes <- preErrorDExp2 %>%
  # only look at mistakes on noncritical (filler) items
  filter(critical != 1) %>%
  # don't want to double-count people for messing the same thing up multiple times
  filter(attemptNum == 0) %>% 
  group_by(gameid) %>%
  tally() %>%
  # implement exclusion criteria of errors on >~10% of non-critical trials
  filter(n >= 2)

mistakeIDs <- as.character(nonCriticalMistakes$gameid)
bannedIDsExp2 <- unique(c(mistakeIDs, nonNativeEnglishIDs))
numParticipantsExp2 <- (length(unique(preMouseDExp2$gameid)) -
                        length(bannedIDsExp2))
```

Remove banned ids from data

```{r}
errorDExp2 <- preErrorDExp2 %>%
  filter(!(gameid %in% bannedIDsExp2))
mouseDExp2 <- preMouseDExp2 %>%
  filter(!(gameid %in% bannedIDsExp2))
messageDExp2 <- preMessageDExp2 %>%
  filter(!(gameid %in% bannedIDsExp2))
```

Make error table

```{r}
eDExp2 <- errorDExp2 %>%
  filter(attemptNum == 0) %>%
  group_by(gameid, condition) %>%
  summarize(n = sum(criticalError)) %>%
  mutate(cond1 = as.numeric(n >= 1)) %>%
  mutate(cond2 = as.numeric(n >= 2)) #

errorTableExp2 <- eDExp2 %>%
  group_by(condition) %>%
  summarise(atLeastOnce = sum(cond1)/numParticipantsExp2, 
            atLeastTwice = sum(cond2)/numParticipantsExp2,
            total = sum(n) / (4 * numParticipantsExp2))
errorTableExp2

# To illustrate how much a few items are driving the effect, we exclude three items 
# where more than 60% of participants made errors.
excludedEDExp2 <- errorDExp2 %>%
  filter(attemptNum == 0) %>%
  filter(!(objectSet %in% c(5, 6))) %>% # Just 5 & 6?
  group_by(gameid, condition) %>%
  summarize(n = sum(criticalError)) %>%
  mutate(cond1 = as.numeric(n >= 1)) %>%
  mutate(cond2 = as.numeric(n >= 2)) %>%
  group_by(condition) %>%
  summarise(atLeastOnce = sum(cond1)/numParticipantsExp2, 
            atLeastTwice = sum(cond2)/numParticipantsExp2,
            total = sum(n) / (4 * numParticipantsExp2))
excludedEDExp2
```

When we look at errors per item, we have to remember that not all items had the same number of participants in the experimental condition.

```{r}
numPlayersPerConditionExp2 = mouseDExp2 %>% 
  filter(critical == 1) %>% 
  filter(attemptNum == 0) %>% 
  group_by(gameid, condition, objectSet) %>% 
  summarize() %>% 
  group_by(condition, objectSet) %>% 
  summarize(total = n()) %>% 
  filter(condition == "exp")
```

Follow-up: are all critical items equal?

```{r}
itemInequalitiesExp2 <- errorDExp2 %>%
  filter(condition == "exp") %>%
  filter(criticalError == 1) %>%
  filter(attemptNum == 0) %>%
  group_by(objectSet) %>%
  tally() %>%
  right_join(numPlayersPerConditionExp2, by = c('objectSet')) %>%
  mutate(objectSet = objectSet,
         errorCount = n, 
         correctCount = total - n) %>%
  mutate(errorRate = errorCount / (errorCount + correctCount)) %>%
  select(objectSet, errorCount, correctCount, errorRate, total)

itemInequalitiesExp2[1,2:4] = c(0, itemInequalitiesExp2[1,]$total, 0)

itemWiseTestExp2 <- chisq.test(itemInequalitiesExp2[-c(1,4,5)])
print(itemWiseTestExp2)
```

Follow-up:

Did error rates go down significantly?


```{r}
exp1NumErrors = eDExp1 %>% 
  filter(condition == "exp") %>% 
  group_by(condition) %>%
  summarize(numErrors = sum(n))
exp2NumErrors = eDExp2 %>% 
  filter(condition == "exp") %>% 
  group_by(condition) %>%
  summarize(numErrors = sum(n))

exp1TotalPossible = 4 * numParticipantsExp1
exp2TotalPossible = 4 * numParticipantsExp2

numErrors = c(exp1NumErrors$numErrors, exp2NumErrors$numErrors)
totalPossible = c(exp1TotalPossible, exp2TotalPossible)
prop.test(numErrors, totalPossible)

# Diff from keysar (2003)?
keysarNumErrors = 45
keysarTotalPossible = 4 * 38
numErrors = c(keysarNumErrors, exp2NumErrors$numErrors)
totalPossible = c(keysarTotalPossible, exp2TotalPossible)
prop.test(numErrors, totalPossible)
```


Set up message data
-------------------

Need to join the coder ratings... 

```{r}
library(boot)
turkerRatings <- read.csv("../../normingExperiment/data/keysarNorming-trials.csv")
relevantProperties <- c("objectSet", "label")

criticalMessagesExp1 <- read.csv("../analysis/messagesExp1.csv") %>%
  left_join(turkerRatings, by = relevantProperties) %>%
  mutate(exp = "Exp.1")
criticalMessagesExp2 <- read.csv("../analysis/messagesExp2.csv") %>%
  right_join(turkerRatings, by = relevantProperties) %>%
  mutate(exp = "Exp.2")

overinformativeCodes <- rbind(criticalMessagesExp1, criticalMessagesExp2) %>%
  filter(!(gameid %in% bannedIDsExp2)) %>%
  filter(!(gameid %in% bannedIDsExp1))

summary(lmer(response ~ exp * referent + (1 | workerid) + (1 | objectSet), data = overinformativeCodes))
  
stat = function(data, indices) {
  d <- data[indices,]
  applicability = d %>%   
    group_by(exp, referent) %>%
    summarize(m = mean(response))
  print(applicability)
  return(applicability$m)
}

res = boot(data = overinformativeCodes, statistic = stat, R = 1000)
Exp1DistrCI = boot.ci(res, type = "basic", index=1)
Exp1targetCI = boot.ci(res, type = "basic", index=2)
Exp2DistrCI = boot.ci(res, type = "basic", index=3)
Exp2targetCI = boot.ci(res, type = "basic", index=4)

plottingDF = data.frame(referent = c("distractor", "target", "distractor", "target"),
                        exp = c("Exp.1", "Exp.1", "Exp.2", "Exp.2"),
                        response = res$t0,
                        lowerCI = c(Exp1DistrCI$basic[1,4], Exp1targetCI$basic[1,4],
                                    Exp2DistrCI$basic[1,4], Exp2targetCI$basic[1,4]),
                        upperCI = c(Exp1DistrCI$basic[1,5], Exp1targetCI$basic[1,5],
                                    Exp2DistrCI$basic[1,5], Exp2targetCI$basic[1,5]))
dodge <- position_dodge(width=0.9)
ggplot(plottingDF, aes(x = exp, y = response, fill = referent)) +
  geom_bar(stat = "identity", position = dodge) +
  geom_errorbar(aes(ymin = lowerCI, ymax = upperCI), position = dodge, width = 0.25) +
  theme_bw() +
  ylab("mean fitness of label")
ggsave("../../writing/cogsci-submission/images/fitnessInteraction.jpeg")

# spread out data, so each row is a label, and each column is a turker
wideRatings = turkerRatings %>% 
  group_by(workerid, label, referent) %>% 
  summarize(m = mean(response)) %>% 
  spread(workerid, m) 

# Interrater reliability
icc(wideRatings[,-c(1,2)],
    model = "twoway", type = "agreement")

```

Want to show whether precision helps avoid errors (mixed model?)

First, we join the error data with the critical item coding data.

```{r}
criticalErrorsExp1 = errorDExp1 %>%
  filter(attemptNum == 0) %>%
  filter(criticalError == 1) %>%
  mutate(exp = "Exp.1") %>%
  select(gameid, objectSet, exp, criticalError)
criticalErrorsExp2 = errorDExp2 %>% 
  filter(attemptNum == 0)%>% 
  filter(criticalError == 1) %>%
  mutate(exp = "Exp.2") %>%
  select(gameid, objectSet, exp, criticalError)

criticalErrors = rbind(criticalErrorsExp1, criticalErrorsExp2)

itemWiseCodes <- overinformativeCodes %>% 
  left_join(criticalErrors, by = c("gameid", "objectSet", "exp")) %>%
  mutate(criticalError = ifelse(is.na(criticalError),0,1))

mmRes <- glmer(criticalError ~ response * referent +  exp + (1 | objectSet),
      data = itemWiseCodes, family = binomial)

summary(mmRes)
```

Set up mouse data

```{r}
mouDataExp2 <- mouseDExp2 %>%
  filter(attemptNum == 0)

mDExp2 <- messageDExp2 %>% 
  filter(attemptNum == 0) %>%
  filter(sender == "director") %>%
  group_by(gameid, objectSet, instructionNum) %>%
  mutate(messageStamp = first(time)) %>%
  select(gameid, condition, attemptNum, instructionNum, critical, 
         objectSet,sender,contents,messageStamp) %>%
  distinct(gameid,contents)

joinedExp2 <- (right_join(mouDataExp2, mDExp2, by = c("gameid", "condition",
                                                      "objectSet", 
                                         "instructionNum", "attemptNum", "critical")))
```

```{r}
dUnfiltExp2 <- joinedExp2 %>%
  filter(critical == 1) %>%
  group_by(objectSet)

dExp2 <- joinedExp2 %>% 
  filter(critical == 1) %>% 
  group_by(objectSet, condition) %>%
  filter(time > messageStamp) %>%
  mutate(mouseY = 600 - mouseY) %>%
  mutate(targetY = 600 - targetY) %>%
  mutate(begTargetX = first(targetX),
         begTargetY = first(targetY),
         distractorX = as.numeric(levels(distractorX))[distractorX],
         distractorY = 600 - as.numeric(levels(distractorY))[distractorY]) %>%
   mutate(begDistrX = first(distractorX),
          begDistrY = first(distractorY)) %>%
   filter(targetX == begTargetX) %>%
   filter(targetY == begTargetY) %>%
   filter(distractorX == begDistrX) %>%
   filter(distractorY == begDistrY) 

```

Compute hover time statistics

```{r}

sem <- function(x) {sd(x, na.rm = T) / sqrt(length(x))}
ci95 <- function(x) {sem(x) * 1.96}

heatMapForLMExp2 <- dExp2 %>%
  group_by(gameid, objectSet) %>%
  mutate(inTargetSquare = as.numeric(mouseX > targetX - 75 
                                     & mouseX < targetX + 75
                                     & mouseY > targetY - 75
                                    & mouseY < targetY + 75)) %>%
  mutate(inDistractorSquare = as.numeric(mouseX > distractorX - 75
                                         & mouseX < distractorX + 75
                                         & mouseY > distractorY - 75
                                         & mouseY < distractorY + 75)) %>%
  group_by(gameid, condition) %>%
  summarise(distractor = sum(inDistractorSquare) / n(),
         target = sum(inTargetSquare) / n()) %>%
  gather(cellType, percent, distractor, target) 

heatMapForLMExp2

t1 <- lm(percent ~ condition * cellType, data = heatMapForLMExp2)
summary(t1)
```

Plot it? 

```{r}
heatMapForPlotExp2 <- dExp2 %>%
  group_by(gameid, objectSet) %>%
  mutate(inTargetSquare = as.numeric(mouseX > targetX - 75 
                                     & mouseX < targetX + 75
                                     & mouseY > targetY - 75
                                    & mouseY < targetY + 75)) %>%
  mutate(inDistractorSquare = as.numeric(mouseX > distractorX - 75
                                         & mouseX < distractorX + 75
                                         & mouseY > distractorY - 75
                                         & mouseY < distractorY + 75)) %>%
  group_by(gameid, condition) %>%
  summarize(distractor = sum(inDistractorSquare) / n(),
         target = sum(inTargetSquare) / n()) %>%
  gather(cellType, percent, distractor, target) %>%
  group_by(condition, cellType) %>%
  summarize(error = sem(percent),
            percent = mean(percent)) 
  
heatMapForPlotExp2

g <- (ggplot(heatMapForPlotExp2, aes(x = condition, y = percent, 
                                     group = cellType, color = cellType)) 
      + geom_line(aes(linetype = cellType), size = 2)
      + geom_errorbar(aes(ymax = percent + error, 
                          ymin = percent - error), size =2 ,
                      width = 0.1)
     + ylim(0, .45)
      + ggtitle("Experiment 2 Hover-Time"))
g
ggsave("../../writing/cogsci-submission/images/exp2MouseTracking.pdf")
```

Compare mouse data from Exp1 w/ mouse data from Exp2:

```{r}
combinedHeatMap = rbind(heatMapForLMExp1 %>%
                          mutate(exp = "Exp.1") %>% 
                          filter(condition == "exp"),
                        heatMapForLMExp2 %>% 
                          mutate(exp = "Exp.2") %>%
                          filter(condition == "exp"))
combinedHeatMapForPlot <- combinedHeatMap %>%
  group_by(cellType, exp) %>%
  summarize(error = sem(percent),
            percent = mean(percent)) 

g <- (ggplot(combinedHeatMapForPlot, aes(x = cellType, y = percent, 
                                  group = exp, color = exp)) 
      + geom_line(aes(linetype = exp), size = 2)
      + geom_errorbar(aes(ymax = percent + error, 
                          ymin = percent - error), size =2 ,
                          width = 0.1)
      + ylim(0, .45)
      + ggtitle("Experiment 2 Hover-Time"))
g
combinedRes = lm(percent ~ exp * cellType, data = combinedHeatMap)
summary(combinedRes)
```

```{r}
# heatMapForPlot$new_labels = as.factor(sapply(X = heatMapForPlot$objectSet, 
#                               FUN = function(v) {return(paste("Item", v))}))
# 
# g <- (ggplot(heatMapForPlot, aes(x = mouseX, y = mouseY, color = condition)) +
#       geom_vline(xintercept = c(0, 150,300,450, 600)) +
#       geom_hline(yintercept = c(0, 150,300,450, 600)) +
#       geom_point() +
#       geom_point(aes(x = begTargetX, y = begTargetY), size = 20,
#                  shape = 4, color = "black", show_guide = FALSE) +
#       geom_point(aes(x = begDistrX, y = begDistrY), size = 20,
#                  shape = 4, color = "grey50", show_guide = FALSE) + 
#       theme(panel.grid.major = element_blank(), 
#             panel.grid.minor = element_blank()) +
#       xlim(0, 600) +
#       ylim(0, 600) +
#       theme(aspect.ratio = 1) +
#       facet_wrap(~ new_labels, nrow = 2))
# g
```