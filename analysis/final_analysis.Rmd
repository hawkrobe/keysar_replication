---
title: "R Notebook"
output: html_notebook
---

# General imports

```{r}
library(jsonlite)
library(tidyverse)
library(ggthemes)
library(lme4)
library(lmerTest)
```

# Experiment 2

## Import turk survey data 

## Import message data

```{r}
d_annotated <- read_csv('../data/final/experiment2/planned_sample/chatMessage/messages_with_annotations.csv') 

# nonNativeSpeakerIDs <- unique((tangramSubjInfo %>% filter(nativeEnglish != "yes"))$gameid)
incompleteIDs <- unique((d_raw %>% group_by(gameid) %>% 
                           filter(length(unique(trialNum)) != 24))$gameid)
confused <- unique((subjInfo %>% filter(understandsInstructions != 'yes'))$gameid)

# Some speakers relied on location in grid (TODO: WHAT ABOUT 'BELOW' PEOPLE?)
location_abusers <- c('8219-bb7861c1-43f4-480c-906b-8441c583c0ab', 
                      '7726-3d4a266f-e56d-4afb-9a79-b40deb690a76', 
                      '5684-f09de856-4d64-423c-b342-b30e7325eb0e', 
                      '7600-346d56b5-bd76-406f-befb-6b47e07d5916')
# Some speakers played this weird taboo game where they gave riddles 
tabooers <- c('2929-d218f724-b45e-416b-af44-5cab5658bad9', #(opposite of white... primary color...)
              '7600-346d56b5-bd76-406f-befb-6b47e07d5916', # MERRY GO ROUND
              '3462-7e95c955-4087-4eb9-bbc8-05338f9a5e4b') # CAN YOU SEE???
badGames <- c(incompleteIDs, pureLocation, confused)

d <- d_annotated %>%
  mutate(numFeatures = colorMention + shapeMention + textureMention) %>%
  filter(!(gameid %in% badGames))
```

## Check basic (no-hidden) pragmatic effect

```{r}
basic.d <- d %>%
  filter(hidden == 'no') %>%
  group_by(gameid, context) %>%
  summarize(m = mean(numRawWords)) %>%
  spread(context, m) %>%
  mutate(diff = close- far,
         ratio = log(close / far))
 
ggplot(basic.d, aes(x = far, y = close)) +
    geom_point() +
    theme_bw() +
    geom_abline(intercept = 0, slope = 1) +
    ylim(1,12) +
    xlim(1,12) +
    theme(aspect.ratio = 1)
```

Aggregated to difference scores:

```{r}
ggplot(basic.d, aes(x = ratio)) +
    geom_histogram(binwidth = 0.25) +
    theme_bw() +
    geom_vline(xintercept = 0) +
    # ylim(1,12) +
    xlim(-4,4) +
    theme(aspect.ratio = 1)

t.test(basic.d$ratio)
```

## Message length collapsing across all subjects

```{r}
dodge <- position_dodge(width=0.9)

d %>%
  group_by(context, hidden) %>%
  summarize(m = mean(numRawWords), se = sd(numRawWords)/sqrt(length(numRawWords))) %>%
  ggplot(aes(x = context, y = m, fill = hidden)) +
    geom_bar(stat = 'identity', position = dodge) +
    geom_errorbar(aes(ymin = m - se, ymax = m + se), position = dodge, width = 0.1) +
    theme_few() +
    ylab('mean # words') +
    theme(aspect.ratio = .5)

ggsave('~/Downloads/aggregated_means.pdf')
```

## Scatter to look at within-subj effects

Some people used exactly the same number of words on every trial...

```{r}
hidden.d %>% 
  filter(context == 'far') %>% 
  mutate(group = case_when(diff < -0 ~ 'anti',
                           diff > 0 ~ 'pro',
                           TRUE ~ 'all_the_things')) %>%
  group_by(group) %>% tally()

all_the_things_ers <- (hidden.d %>% filter(context =='far') %>% filter(diff == 0))$gameid
```

```{r}
hidden.d <- d %>%
  group_by(gameid, context, hidden) %>%
  summarize(m = mean(numRawWords)) %>%
  spread(hidden, m) %>%
  mutate(diff = yes- no,
         ratio = log(yes/no)) 

ggplot(hidden.d, aes(x = no, y = yes)) +
    geom_point() +
    facet_wrap(~ context) +
    theme_bw() +
    geom_abline(intercept = 0, slope = 1) +
    ylim(1,15) +
    ylab('# words (with occlusions)') +
    xlab('# words (without occlusions)') +
    ggtitle('Within-pair comparisons of reference w/ and w/out occlusion') +
    xlim(1,15) +
    theme(aspect.ratio = 1)

ggsave('~/Downloads/scatter.pdf')
```

Histogram

```{r}
ggplot(hidden.d %>% filter(!(gameid %in% all_the_things_ers)) %>% group_by(context) %>% mutate(m = mean(diff)), aes(x = diff)) +
    geom_histogram(binwidth = 0.33) +
    theme_bw() +
    geom_vline(xintercept = 0, linetype = 2) +
    geom_vline(aes(xintercept = m), color = 'red') +
    facet_wrap(~ context) +
    # ylim(1,12) +
    xlim(-6,6) +
    theme(aspect.ratio = 1)

ggsave("~/Downloads/histograms.pdf")
```

```{r}
hidden.d %>%
  group_by(context) %>%
  summarize(m = mean(diff), se = sd(diff)/sqrt(length(diff))) %>%
  ggplot(aes(x = context, y = m)) +
    geom_bar(stat = 'identity') +
    geom_errorbar(aes(ymin = m - se, ymax = m + se), width = 0) +
    theme_few() +
    ylim(-3, 3) +
    ylab('# words (occlusions - no occlusions)')
  
```

# Stats

Simple effect of hidden-ness in 'far' contexts 

```{r}
summary(lmer(numRawWords ~ hidden + (1 + hidden | gameid), 
             data = d %>% 
               filter(context == 'far') %>%
               filter(!(gameid %in% all_the_things_ers))
               ))
t.test(numRawWords ~ hidden, data = d %>% filter(context == 'far') , var.equal = FALSE)
```

interaction-y way

```{r}
summary(lmer(numRawWords ~ context * hidden + (1 + context * hidden | gameid), data = d %>% filter(!(gameid %in% all_the_things_ers))))
```

helmert coding way (one way of slicing)

```{r}
d.regression <- d %>% 
  unite(condition, context, hidden) %>%
  ungroup() %>%
  mutate(condition = ordered(condition, levels = c('far_no', 'close_no', 'far_yes', 'close_yes')))
contrasts(d.regression$condition) <- contr.helmert(4)
summary(lmer(numRawWords ~ condition + (1 + condition | gameid), data = d.regression))
```

## Use feature data instead

```{r}
d %>% 
  group_by(context, occlusions) %>% 
  summarize(color = mean(colorMention), shape = mean(shapeMention), texture = mean(textureMention))
```

Histograms of number of features mentioned in each condition

```{r}
ggplot(d, aes(x = numFeatures)) +
  geom_histogram(binwidth = 1) +
  facet_grid(context ~ occlusions) +
  theme_few()
```

```{r}
d %>% group_by(context, occlusions) %>% 
  mutate(numTrials = length(text)) %>% 
  group_by(context, occlusions, colorMention, textureMention) %>% 
  summarize(n = length(text)/mean(numTrials)) %>%
  ggplot(aes(x = colorMention, y = textureMention, fill = n)) +
    geom_bin2d(stat = 'identity') +
    stat_bin2d(geom = "text", aes(label = round(n, 2))) +
    scale_fill_gradient(low = "white", high = "red") +
    facet_grid(occlusions ~ context) +
    theme_few()
```

Note: Random intercept doesn't converge (less variance in these numbers...)

```{r}
summary(lmer(numFeatures ~ context * occlusions + (1 + context + occlusions | gameid), data = d))
```

```{r}
summary(glmer(colorMention ~ occlusions + (1 + occlusions | gameid), family = 'binomial', data = d))
```

```{r}
summary(glmer(textureMention ~ occlusions + (1 + occlusions | gameid), family = 'binomial', data = d))
```

```{r}
d %>% 
  group_by(context, occlusions) %>% 
  summarize(numFeatures = mean(numFeatures))
```