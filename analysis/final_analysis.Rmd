---
title: "R Notebook"
output: html_notebook
---

# Experiment 2

## Import message data

```{r}
d_raw <- read_tsv('../data/final/experiment2/pilot0/chatMessage/pilot0_messages.csv')

# nonNativeSpeakerIDs <- unique((tangramSubjInfo %>% filter(nativeEnglish != "yes"))$gameid)
incompleteIDs <- unique((d %>% group_by(gameid) %>% 
                           filter(length(unique(trialNum)) != 24))$gameid)

# Some speakers relied purely on location in grid
pureLocation <- c('0180-a541e54c-5dea-4d06-9a21-9b842316eb59', '0101-0b659560-f05a-471a-89ac-60469e9c867f')
badGames <- c(incompleteIDs, pureLocation)

d <- d_raw %>%
  group_by(gameid, trialNum, occlusions, context) %>%
  summarize(text = paste0(text, collapse = ' ')) %>%   # Concatenate multiple utterance on same trial
  mutate(numRawWords = str_count(text, "\\S+")) %>%
  mutate(hidden = ifelse(occlusions == 'none', 'no', 'yes')) %>%
  filter(!(gameid %in% badGames))
```

## Check basic (no-hidden) pragmatic effect

```{r}
d %>%
  filter(hidden == 'no') %>%
  group_by(gameid, context) %>%
  summarize(m = mean(numRawWords)) %>%
  spread(context, m) %>%
  mutate(diff = close - far) %>%
  ggplot(aes(x = far, y = close)) +
    geom_point() +
    theme_bw() +
    geom_abline(intercept = 0, slope = 1) +
    ylim(1,12) +
    xlim(1,12) +
    theme(aspect.ratio = 1)

  summarize(m = mean(numRawWords), se = sd(numRawWords)/sqrt(length(numRawWords))) %>%
    spread(context, numRawWords)

```

## Message length collapsing across all subjects

```{r}
dodge <- position_dodge(width=0.9)

d %>%
  group_by(context, hidden) %>%
  summarize(m = mean(numRawWords), se = sd(numRawWords)/sqrt(length(numRawWords))) %>%
  ggplot(aes(x = hidden, y = m, fill = context)) +
    geom_bar(stat = 'identity', position = dodge) +
    geom_errorbar(aes(ymin = m - se, ymax = m + se), position = dodge, width = 0.1) +
    theme_bw()
```

## Scatter to look at within-subj effects

```{r}
d %>%
  group_by(gameid, context, hidden) %>%
  summarize(m = mean(numRawWords)) %>%
  spread(hidden, m) %>%
  mutate(diff = yes - no) %>%
  ggplot(aes(x = no, y = yes)) +
    geom_point() +
    facet_wrap(~ context) +
    theme_bw() +
    geom_abline(intercept = 0, slope = 1) +
    ylim(1,12) +
    ylab('# words (with occlusions)') +
    xlab('# words (without occlusions)') +
    ggtitle('Within-pair comparisons of reference w/ and w/out occlusion') +
    xlim(1,12) +
    theme(aspect.ratio = 1)

ggsave('~/Downloads/scatter.pdf')
```

```{r}
d %>%
  group_by(gameid, context, hidden) %>%
  summarize(m = mean(numRawWords)) %>%
  spread(hidden, m) %>%
  mutate(diff = yes - no) %>%
  group_by(context) %>%
  summarize(m = mean(diff), se = sd(diff)/sqrt(length(diff))) %>%
  ggplot(aes(x = context, y = m)) +
    geom_bar(stat = 'identity') +
    geom_errorbar(aes(ymin = m - se, ymax = m + se), width = 0) +
    theme_few() +
    ylim(-3, 3) +
    ylab('# words (occlusions - no occlusions)')
  
```

# Regression

helmert coding way (one way of slicing)

```{r}
library(ggthemes)
library(lme4)
library(lmerTest)

d.regression <- d %>% 
  unite(condition, context, hidden) %>%
  ungroup() %>%
  mutate(condition = ordered(condition, levels = c('far_no', 'close_no', 'far_yes', 'close_yes')))
contrasts(d.regression$condition) <- contr.helmert(4)
summary(lmer(numRawWords ~ condition + (1 + condition | gameid), data = d.regression))
```

interaction-y way

```{r}
summary(lmer(numRawWords ~ context * hidden + (1 + context + hidden | gameid), data = d))
```